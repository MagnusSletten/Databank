name: Run tests

on:
  pull_request_target:
    branches:
      - 'dev_cicd'
    paths:
      - 'Scripts/**/*.py'
      - 'Scripts/**/*.sh'
      - 'Scripts/**/*.ipynb'

jobs:
  DockerCleanup:
    if: github.repository == 'MagnusSletten/Databank'
    uses: MagnusSletten/Databank/.github/workflows/DockerCleanup.yml@dev_cicd
    with:
      delete_images: false

  Tests:
    if: github.repository == 'MagnusSletten/Databank'
    needs: DockerCleanup
    runs-on: nrec-large
    container:
      image: nmrlipids/core
    env:
      TQDM_DISABLE: True

    steps:
      - name: Fetch and checkout pull request branch
        run: |
          PR_BRANCH=ci_pr_${{ github.event.pull_request.number }}
          git fetch origin pull/${{ github.event.pull_request.number }}/head:$PR_BRANCH
          git checkout $PR_BRANCH

          
      - name: Install package and test dependencies
        run: |
          pip install --break-system-packages -e .

      - name: Run tests
        run: pytest -vs
