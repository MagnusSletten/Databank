#Builder stage is meant to build GROMACS without keeping additional needed dependencies
FROM debian:bookworm-slim AS builder

# Define arguments for GROMACS version
ARG GROMACS_VERSION=2025.2
ENV GROMACS_VERSION=${GROMACS_VERSION}

# Install system dependencies
RUN apt-get update && apt-get install -y \
    bash \
    wget \
    python3 \
    python3-pip \
    build-essential && \
    rm -rf /var/lib/apt/lists/*

# Install the latest CMake via pip which is needed for latest GROMACS versions
RUN pip3 install --no-cache-dir cmake --break-system-packages

# Install GROMACS
RUN wget https://ftp.gromacs.org/gromacs/gromacs-${GROMACS_VERSION}.tar.gz && \
    tar xfz gromacs-${GROMACS_VERSION}.tar.gz && \
    rm gromacs-${GROMACS_VERSION}.tar.gz && \
    cd gromacs-${GROMACS_VERSION} && \
      mkdir build && cd build && \
      cmake .. -DGMX_BUILD_OWN_FFTW=ON -DREGRESSIONTEST_DOWNLOAD=ON && \
      make && \
      make check && \
      make install && \
      rm -rf /var/lib/apt/lists/* && \
    cd ../.. && rm -rf gromacs-${GROMACS_VERSION}

# Final stage to create runtime image
FROM debian:bookworm-slim AS final

# Copy the installed GROMACS from the builder stage
COPY --from=builder /usr/local/gromacs /usr/local/gromacs

# Add dev-requirement file for DatabankLib
COPY Scripts/DatabankLib/requirements-dev.txt requirements.txt

RUN apt-get update && apt-get install -y \
    bash \
    git \
    curl \
    python3 \
    python3.11-venv \
    python3-pip  &&\  
    rm -rf /var/lib/apt/lists/*

#Create the virtual enviroment for python
RUN python3.11 -m venv /opt/venv

#Add enviroment to PATH
ENV PATH="/opt/venv/bin:$PATH"
RUN useradd -m -s /bin/bash runner
RUN chown -R runner:runner /opt/venv

RUN pip install -r requirements.txt --no-cache-dir

# Create a symbolic link for python -> python3
RUN ln -s /usr/bin/python3 /usr/bin/python

# Expose GROMACS binaries via PATH
ENV PATH="/usr/local/gromacs/bin:${PATH}"

# Switch to the non-root user
USER runner

# Set the working directory inside the container
WORKDIR /workspace 