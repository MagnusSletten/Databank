services:
  recompute_databank:
    image: nmrlipids/core
    entrypoint: ["/bin/bash", "-c", "git clone https://x-access-token:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git --branch=$BRANCH_NAME && cd Databank && python Scripts/DockerScripts/DispatchRecompute.py"]
    environment:
      - GITHUB_TOKEN
      - GITHUB_REPOSITORY
      - BRANCH_NAME

  recompute_instance:
    image: nmrlipids/core
    command: /bin/bash -c "source /usr/local/gromacs/bin/GMXRC && git clone https://x-access-token:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git Databank && cd Databank && git fetch origin && git branch -r && git checkout $BRANCH_NAME && Scripts/DockerScripts/RecomputeSimdata.sh"
    environment:
      - GITHUB_TOKEN
      - GITHUB_REPOSITORY
      - BRANCH_NAME

  tests:
    image: nmrlipids/core
    command: /bin/bash -c "git clone --branch $BRANCH_NAME https://github.com/MagnusSletten/Databank.git /app/Databank && cd /app/Databank/Scripts/tests/ && source /usr/local/gromacs/bin/GMXRC && pytest -vs"
  

  add_data:
    image: nmrlipids/core
    environment:
      REPO_URL: ${REPO_URL}
      BRANCH_NAME: ${BRANCH_NAME}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      TARGET_BRANCH: ${TARGET_BRANCH}
    command: /bin/bash -c "source /usr/local/gromacs/bin/GMXRC && git clone https://x-access-token:${GITHUB_TOKEN}@github.com/MagnusSletten/Databank.git --branch=${BRANCH_NAME} Databank && cd Databank && Scripts/DockerScripts/RunnerGitConfig.sh && Scripts/DockerScripts/GetNewExperimentData.sh && Scripts/DockerScripts/GetNewSimData.sh"

